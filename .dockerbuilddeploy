#!/bin/bash
## Author: Mark Shust <mark@shust.com>
## Version: 2.0.0
## Repo: https://github.com/markoshust/docker-meteor
## Description: Script for bundling, building & deploying a Meteor app with Docker

TARGET=$1
VERSION=$2
BASE_APP_NAME=barbaz
APP_DIR=$PWD
BUILD_DIR=../build
DOCKER_TAG=foo/$BASE_APP_NAME
SSH_CONN=root@barbaz.com
NODE_ENV=production
PORT=80
ROOT_URL=https://barbaz.com
MONGO_URL="mongodb://user:pass@localhost:27017/barbaz"
MONGO_OPLOG_URL="mongodb://user:pass@localhost:27017/local?authSource=admin"

if [ -z "$TARGET" ]; then
  echo 'Missing deployment target. Possible values: staging, production'
  exit 0
elif [ -z "$VERSION" ]; then
  echo 'Missing version number. Ex. 1.0.0'
  exit 0
fi

case "$TARGET" in
  'staging' | 'production')
    if [ "$TARGET" = 'staging' ]; then
      APP_NAME=$BASE_APP_NAME-staging
      SERVER=https://staging.barbaz.com
      VERSION="$VERSION-staging"
    elif [ "$TARGET" = 'production' ]; then
      APP_NAME=$BASE_APP_NAME
      SERVER=https://barbaz.com
    fi
    echo "Building & deploying $APP_NAME:$VERSION"
    echo ""
    ;;
  *)
    echo 'Invalid deployment target. Possible values: staging, production'
    exit 0
    ;;
esac

rm -rf $BUILD_DIR

npm i

echo "Building Meteor bundle to $BUILD_DIR"
meteor build --architecture=os.linux.x86_64 --server=$ROOT_URL --directory $BUILD_DIR

echo "Tagging version..."
git tag $VERSION
git push --tags

echo "Building Dockerfile..."
cp Dockerfile $BUILD_DIR/bundle/
cd $BUILD_DIR/bundle/
docker build -t $DOCKER_TAG:$VERSION .
docker push $DOCKER_TAG:$VERSION

PRERUN_COMMAND="docker stop $BASE_APP_NAME && docker rm $BASE_APP_NAME"
RUN_COMMAND="docker run \
    -e NODE_ENV=$NODE_ENV \
    -e PORT=$PORT \
    -e ROOT_URL=$ROOT_URL \
    -e MONGO_URL=\"${MONGO_URL}\" \
    -e MONGO_OPLOG_URL=\"${MONGO_OPLOG_URL}\" \
    --name $BASE_APP_NAME \
    -d $DOCKER_TAG:$VERSION"

ssh $SSH_CONN $PRERUN_COMMAND
ssh $SSH_CONN $RUN_COMMAND
